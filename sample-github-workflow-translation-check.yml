# GitHub Actions Workflow for Translation Verification
# Place this file in: .github/workflows/translation-check.yml

name: Translation Verification

on:
  pull_request:
    paths:
      - 'messages/**'
      - 'src/**/*.tsx'
      - 'src/**/*.ts'
  push:
    branches:
      - main
    paths:
      - 'messages/**'

jobs:
  verify-translations:
    name: Verify Translation Integrity
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run translation verification script
        id: verify
        run: |
          python3 verify_translations.py > translation_output.txt 2>&1
          EXIT_CODE=$?
          cat translation_output.txt
          exit $EXIT_CODE
        continue-on-error: true

      - name: Upload verification report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: translation-verification-report
          path: |
            translation_verification_report.json
            translation_output.txt
          retention-days: 30

      - name: Comment PR with translation issues
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let report;
            try {
              report = JSON.parse(fs.readFileSync('translation_verification_report.json', 'utf8'));
            } catch (err) {
              console.log('Could not read report file');
              return;
            }

            const missingFr = report.issues.missing_translations.fr.length;
            const missingNl = report.issues.missing_translations.nl.length;
            const extraFr = report.issues.extra_keys.fr.length;
            const extraNl = report.issues.extra_keys.nl.length;

            const coverageFr = report.summary.coverage.fr.toFixed(2);
            const coverageNl = report.summary.coverage.nl.toFixed(2);

            let comment = `## ğŸŒ Translation Verification Report\n\n`;

            if (missingFr > 0 || missingNl > 0 || extraFr > 0 || extraNl > 0) {
              comment += `### âš ï¸ Issues Found\n\n`;
              comment += `| Language | Coverage | Missing Keys | Extra Keys |\n`;
              comment += `|----------|----------|--------------|------------|\n`;
              comment += `| ğŸ‡«ğŸ‡· French | ${coverageFr}% | ${missingFr} | ${extraFr} |\n`;
              comment += `| ğŸ‡³ğŸ‡± Dutch | ${coverageNl}% | ${missingNl} | ${extraNl} |\n\n`;

              if (missingFr > 0) {
                comment += `#### Missing in French (${Math.min(5, missingFr)} of ${missingFr}):\n\n`;
                report.issues.missing_translations.fr.slice(0, 5).forEach(key => {
                  comment += `- \`${key}\`\n`;
                });
                if (missingFr > 5) {
                  comment += `\n_... and ${missingFr - 5} more_\n`;
                }
                comment += `\n`;
              }

              if (extraFr > 0) {
                comment += `#### Extra keys in French:\n\n`;
                report.issues.extra_keys.fr.forEach(key => {
                  comment += `- \`${key}\` (not in English)\n`;
                });
                comment += `\n`;
              }

              comment += `### ğŸ“ Action Required\n\n`;
              comment += `1. **Missing translations**: Add missing keys to French and Dutch translation files\n`;
              comment += `2. **Extra keys**: Remove unused keys or add them to English if needed\n\n`;
              comment += `See the [Translation Verification Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for full details.\n`;
            } else {
              comment += `### âœ… All Checks Passed\n\n`;
              comment += `All translation files are in sync!\n\n`;
              comment += `| Language | Coverage |\n`;
              comment += `|----------|----------|\n`;
              comment += `| ğŸ‡¬ğŸ‡§ English | 100% |\n`;
              comment += `| ğŸ‡«ğŸ‡· French | ${coverageFr}% |\n`;
              comment += `| ğŸ‡³ğŸ‡± Dutch | ${coverageNl}% |\n`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if translation issues found
        if: steps.verify.outcome == 'failure'
        run: |
          echo "âŒ Translation verification failed. Please fix the issues above."
          exit 1

  test-translations:
    name: Run Translation Tests
    runs-on: ubuntu-latest
    needs: verify-translations

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run translation tests
        run: npm run test -- tests/translations.test.ts

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: translation-test-results
          path: coverage/
          retention-days: 30

  lint-translation-files:
    name: Lint Translation JSON Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate JSON syntax
        run: |
          echo "Validating messages/en.json..."
          jq empty messages/en.json || exit 1

          echo "Validating messages/fr.json..."
          jq empty messages/fr.json || exit 1

          echo "Validating messages/nl.json..."
          jq empty messages/nl.json || exit 1

          echo "âœ… All JSON files are valid!"

      - name: Check for duplicate keys
        run: |
          # Check for duplicate keys in JSON files (jq will error if found)
          for file in messages/*.json; do
            echo "Checking $file for duplicate keys..."
            jq -e 'walk(if type == "object" then with_entries(select(.key)) else . end)' "$file" > /dev/null
          done

      - name: Check file encoding
        run: |
          # Ensure files are UTF-8 encoded
          for file in messages/*.json; do
            if ! file "$file" | grep -q "UTF-8"; then
              echo "âŒ $file is not UTF-8 encoded"
              exit 1
            fi
          done
          echo "âœ… All files are UTF-8 encoded"

  generate-translation-report:
    name: Generate Translation Report
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate comprehensive report
        run: |
          python3 verify_translations.py
          python3 analyze_missing_categories.py > category_analysis.txt

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: translation-reports
          path: |
            translation_verification_report.json
            TRANSLATION_VERIFICATION_REPORT.md
            category_analysis.txt
          retention-days: 90

      - name: Create Issue if translations missing
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let report;
            try {
              report = JSON.parse(fs.readFileSync('translation_verification_report.json', 'utf8'));
            } catch (err) {
              return;
            }

            const missingTotal = report.issues.missing_translations.fr.length +
                                 report.issues.missing_translations.nl.length;

            if (missingTotal > 0) {
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'translation,automated',
                state: 'open'
              });

              // Don't create duplicate issues
              if (issues.data.length > 0) {
                console.log('Translation issue already exists');
                return;
              }

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸŒ ${missingTotal} Missing Translations Detected`,
                labels: ['translation', 'automated', 'help wanted'],
                body: `## Translation Gap Detected\n\n` +
                      `Our automated translation check has detected missing translations:\n\n` +
                      `- ğŸ‡«ğŸ‡· French: ${report.issues.missing_translations.fr.length} missing keys\n` +
                      `- ğŸ‡³ğŸ‡± Dutch: ${report.issues.missing_translations.nl.length} missing keys\n\n` +
                      `Current coverage:\n` +
                      `- French: ${report.summary.coverage.fr.toFixed(2)}%\n` +
                      `- Dutch: ${report.summary.coverage.nl.toFixed(2)}%\n\n` +
                      `See the [latest translation report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.\n\n` +
                      `### Action Required\n\n` +
                      `1. Review missing translation keys in the report\n` +
                      `2. Add translations or use [EN] prefix for English placeholders\n` +
                      `3. Consider professional translation services for quality\n\n` +
                      `_This issue was automatically created by the Translation Verification workflow._`
              });
            }
